# Manage Python Projects using conda and pip-tools

## Setup Python environment

- Use **conda** for managing python and CUDA version and **pip-tools** for managing python package dependencies
- Use **Makefile** for making setup simple.

- Install miniconda

`$ wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh && bash Miniconda3-latest-Linux-x86_64.sh`
environment.yaml

### Install python + CUDA using Conda

- Add environment.yaml with the following contents

```yaml
name: fastchai
channels:
  - defaults
dependencies:
  - python=3.6  # Google Colab is still on Python 3.6
  - cudatoolkit=10.1
  - cudnn=7.6
  - pip
  - pip:
    - pip-tools
```

- Add requirements/dev.in file with the following contents

```in
  -c prod.txt
bandit
black
editdistance
itermplot
jupyterlab
matplotlib
mypy
nltk
pycodestyle
pydocstyle
pylint
pytest
pyyaml
tornado
safety
scipy
pillow
wandb
```

- Add requirements/prod.in with the following contents

```in
boltons
editdistance
flask
h5py
numpy
opencv-python-headless>=4.4
pytorch-lightning
requests
toml
torch
torchvision
tqdm
```

- Add Makefile to make the setup easier.

```Makefile
all: conda-update pip-tools

# Arcane incantation to print all the other targets, from https://stackoverflow.com/a/26339924
help:
    @$(MAKE) -pRrq -f $(lastword $(MAKEFILE_LIST)) : 2>/dev/null | awk -v RS= -F: '/^# File/,/^# Finished Make data base/ {if ($$1 !~ "^[#.]") {print $$1}}' | sort | egrep -v -e '^[^[:alnum:]]' -e '^$@$$'

conda-update:
    conda env update --prune -f environment.yml

# Compile exact pip packages
pip-tools:
    pip install pip-tools
    pip-compile requirements/prod.in && pip-compile requirements/dev.in
    pip-sync requirements/prod.txt requirements/dev.txt
```

- Run `make conda-update` to create an environment called fastchai. This will ensure right python version is installed.

- Activate the conda environment `conda activate fastchai`

### Install python packages

- Install python packages by running `make pip-tools`. We have dev and production dependencies separated out. And also lockfile of exact versions for all dependencies autogenerated in requirements-dev.txt and requirements.txt

## Set PYTHONPATH

- Add `export PYTHONPATH=.:$PYTHONPATH` to the `~/.bashrc` or `~/.zshrc`

## Reference

https://github.com/full-stack-deep-learning/fsdl-text-recognizer-2021-labs/blob/main/setup/readme.md